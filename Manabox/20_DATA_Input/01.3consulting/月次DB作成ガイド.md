# 月次DB作成ガイド

## 概要

このガイドでは、月次の実績（#1）と予算（#2）のエクセルファイルを、マスターフォーマット#3に基づいて統合し、SharePoint用のエクセルDB（月毎に縦に並ぶ形式）を作成する方法を説明します。

---

## 📋 必要なファイル

1. **マスターフォーマット#3_最終版.csv** - 統合マスターフォーマット
2. **実績データ（#1）のエクセルファイル** - 月次の実績PL
3. **予算データ（#2）のエクセルファイル** - 月次の予算PL

---

## 📊 エクセルファイルの構造

### 実績データ（#1）の構造例

エクセルファイルは以下のような構造である必要があります：

#### パターン1: 横にAccount Codeが並ぶ形式（写真の形式）

```
| Date       | 売上 (Sales) | サービス提供の売上 (Services sale) | ... |
|------------|--------------|----------------------------------|-----|
| Apr-25     | 2,880,129,396 | 2,880,129,396                  | ... |
| May-25     | 3,000,000,000 | 3,000,000,000                  | ... |
| Jun-25     | 3,200,000,000 | 3,200,000,000                  | ... |
```

**列の要件**:
- **Date列**: 日付（月）
- **Account Code列**: 各Account Codeが列名になっている
- **数値**: 各セルに金額が入っている

#### パターン2: 縦にAccount Codeが並ぶ形式

```
| Date       | Account Code | Amount |
|------------|--------------|--------|
| Apr-25     | 511          | 2,880,129,396 |
| Apr-25     | 5113         | 2,880,129,396 |
| May-25     | 511          | 3,000,000,000 |
| May-25     | 5113         | 3,000,000,000 |
```

**列の要件**:
- **Date列**: 日付（月）
- **Account Code列**: Account Codeが入っている
- **Amount列**: 金額が入っている

### 予算データ（#2）の構造

実績データと同じ構造で、予算金額が入っている形式

---

## 🚀 使用方法

### ステップ1: ファイルパスの設定

`create_monthly_db.py`を開き、以下の部分を実際のファイルパスに変更してください：

```python
# 実績データと予算データのパス（実際のファイルパスに置き換えてください）
actual_file = 'path/to/actual_data.xlsx'  # #1（実績）のエクセルファイル
budget_file = 'path/to/budget_data.xlsx'  # #2（予算）のエクセルファイル
```

例：
```python
actual_file = '/Users/sugenotomohiro/Desktop/実績データ_2025.xlsx'
budget_file = '/Users/sugenotomohiro/Desktop/予算データ_2025.xlsx'
```

### ステップ2: スクリプトの実行

```bash
cd /Users/sugenotomohiro/Desktop/CURSOR/Manabox/20_DATA_Input/01.3consulting
python3 create_monthly_db.py
```

### ステップ3: 出力ファイルの確認

`月次DB_SharePoint用.xlsx`が作成されます。

---

## 📐 出力ファイルの構造

出力ファイルは以下のような構造になります（月毎に縦に並ぶ形式）：

```
| Year_Month | Date       | Account Code | Internal Account Name | Actual_Amount | Budget_Amount | Variance | Variance_Rate | ... |
|------------|------------|--------------|----------------------|---------------|---------------|----------|---------------|-----|
| 2025-04    | 2025-04-01 | 511          | 売上                  | 2,880,129,396 | 2,800,000,000 | 80,129,396 | 2.86%         | ... |
| 2025-04    | 2025-04-01 | 5113         | サービス提供の売上     | 2,880,129,396 | 2,800,000,000 | 80,129,396 | 2.86%         | ... |
| 2025-05    | 2025-05-01 | 511          | 売上                  | 3,000,000,000 | 2,900,000,000 | 100,000,000 | 3.45%         | ... |
| 2025-05    | 2025-05-01 | 5113         | サービス提供の売上     | 3,000,000,000 | 2,900,000,000 | 100,000,000 | 3.45%         | ... |
```

**列の説明**:
- **Year_Month**: 年月（YYYY-MM形式）
- **Date**: 日付
- **Account Code**: 会計コード
- **Internal Account Name**: アカウント名
- **Actual_Amount**: 実績金額
- **Budget_Amount**: 予算金額
- **Variance**: 差異（実績 - 予算）
- **Variance_Rate**: 差異率（%）

---

## 🔧 カスタマイズ

### エクセルファイルの列名が異なる場合

`create_monthly_db.py`の以下の関数を修正してください：

```python
def load_actual_data(file_path, sheet_name=None, account_code_col='Account Code', date_col='Date', amount_col='Amount'):
```

パラメータを変更：
- `account_code_col`: Account Code列の名前
- `date_col`: 日付列の名前
- `amount_col`: 金額列の名前（パターン2の場合）

### シート名を指定する場合

```python
actual_df = load_actual_data(actual_file, sheet_name='実績データ')
budget_df = load_budget_data(budget_file, sheet_name='予算データ')
```

---

## 📤 SharePointへのアップロード

### 方法1: 手動アップロード

1. SharePointのドキュメントライブラリに移動
2. 「アップロード」をクリック
3. `月次DB_SharePoint用.xlsx`を選択
4. アップロード

### 方法2: 自動アップロード（Power Automate使用）

Power Automateで以下のフローを作成：
1. ファイルが作成されたら（ローカルフォルダ）
2. SharePointにファイルをアップロード

### 方法3: スクリプトで直接アップロード

Pythonの`shareplum`ライブラリを使用して自動アップロードすることも可能です。

---

## 🔗 Looker Studioでの使用

1. Looker Studioで新しいデータソースを作成
2. 「SharePoint」を選択
3. SharePointのファイルを選択
4. テーブルを選択
5. データを可視化

---

## ⚠️ 注意事項

### Account Codeの一致

- 実績データと予算データのAccount Codeは、マスターフォーマット#3と完全一致する必要があります
- 不一致がある場合、該当データは結合されません

### 日付形式

- 日付は「YYYY-MM-DD」形式または「YYYY-MM」形式である必要があります
- 「Apr-25」形式の場合、自動的に「2025-04」に変換されます

### データ型

- 金額は数値である必要があります
- 文字列が含まれている場合、エラーになる可能性があります

---

## 🐛 トラブルシューティング

### エラー1: Account Code列が見つかりません

**原因**: 列名が異なる

**解決方法**:
1. エクセルファイルの列名を確認
2. `load_actual_data`関数の`account_code_col`パラメータを変更

### エラー2: 日付列が見つかりません

**原因**: 日付列の名前が異なる

**解決方法**:
1. エクセルファイルの日付列名を確認
2. `load_actual_data`関数の`date_col`パラメータを変更

### エラー3: データが結合されない

**原因**: Account Codeが一致していない

**解決方法**:
1. 実績データと予算データのAccount Codeを確認
2. マスターフォーマット#3のAccount Codeと一致しているか確認
3. スペースや特殊文字の有無を確認

---

## 📝 サンプルデータ

実際のエクセルファイルがない場合、以下のようなサンプルデータを作成できます：

### 実績データのサンプル（エクセル形式）

| Date   | 511 | 5113 | 622  |
|--------|-----|------|------|
| Apr-25 | 2880129396 | 2880129396 | 500000000 |
| May-25 | 3000000000 | 3000000000 | 520000000 |
| Jun-25 | 3200000000 | 3200000000 | 540000000 |

### 予算データのサンプル（エクセル形式）

| Date   | 511 | 5113 | 622  |
|--------|-----|------|------|
| Apr-25 | 2800000000 | 2800000000 | 480000000 |
| May-25 | 2900000000 | 2900000000 | 500000000 |
| Jun-25 | 3100000000 | 3100000000 | 520000000 |

---

## 🔄 更新フロー

### 月次更新

1. 新しい月の実績データを取得
2. 新しい月の予算データを取得
3. `create_monthly_db.py`を実行
4. 出力ファイルをSharePointにアップロード
5. Looker Studioでデータを更新

### 自動化

Power Automateやタスクスケジューラーを使用して、毎月自動実行することも可能です。

---

## 📞 サポート

問題が発生した場合：
1. エラーメッセージを確認
2. このガイドの「トラブルシューティング」セクションを参照
3. エクセルファイルの構造を確認

---

このガイドに従って、月次DBを作成できます。不明な点があれば、スクリプトのコメントやエラーメッセージを確認してください。

