# Looker Studio用 会計データベース設計書

## 概要

本ドキュメントは、#1（実績）と#2（予算）の会計データを統合したマスターフォーマット#3を使用して、Looker Studioで実績と予算を比較・可視化するためのデータベース設計書です。

## データ構造

### マスターフォーマット#3

**ファイル名**: `マスターフォーマット#3_最終版.csv`

**統計情報**:
- マスター項目数: 128件
- サブアイテム総数: 41件
- #1と#2の両方: 118件
- #1のみ（実績のみ）: 6件
- #2のみ（予算のみ）: 4件

### データスキーマ

#### 基本列

| 列名 | データ型 | 説明 | 用途 |
|------|---------|------|------|
| Account Code アカウント | STRING | 会計コード（階層構造） | 主キー、フィルタ、グループ化 |
| (階層レベル2) | STRING | 会計コード2階層目 | 階層構造の維持 |
| (階層レベル3) | STRING | 会計コード3階層目 | 階層構造の維持 |
| Internal code | STRING | 内部コード | 識別子 |
| Internal Account Name | STRING | 内部アカウント名 | 表示名 |
| KEIEI houkoku | STRING | 経営報告書分類 | 分類 |
| 詳細 | STRING | 詳細説明（日本語） | 説明 |
| Description | STRING | 説明（英語） | 説明 |
| Chỉ tiêu | STRING | 指標（ベトナム語） | 説明 |
| Đơn giá | NUMBER | 単価（予算金額） | 予算金額 |
| Source | STRING | データソース（Both/#1/#2） | データ存在確認 |
| Level | NUMBER | 階層レベル（0-3） | 階層構造の管理 |
| Has Data #1 | STRING | 実績データ有無（Yes/No） | フィルタ |
| Has Data #2 | STRING | 予算データ有無（Yes/No） | フィルタ |

#### 階層構造

Account Codeは以下の階層構造を持ちます：

- **レベル0**: 最上位（例: 511, 622, 642）
- **レベル1**: 2階層目（例: 5113, 6221, 6421）
- **レベル2**: 3階層目（例: 51131, 62211, 642111）
- **レベル3**: 4階層目（サブアイテム、Account Codeなし）

### データソース

#### #1（実績データ）
- 実績値を含むデータ
- `Has Data #1 = Yes` の項目

#### #2（予算データ）
- 予算値を含むデータ
- `Has Data #2 = Yes` の項目
- `Đơn giá` 列に予算金額が記載

#### 両方（Both）
- 実績と予算の両方を含む項目
- `Source = Both` の項目

## Looker Studioでのデータ接続

### 1. データソースの追加

1. Looker Studioで新しいデータソースを作成
2. 「ファイルをアップロード」を選択
3. `マスターフォーマット#3_最終版.csv` をアップロード

### 2. データ型の設定

以下のフィールドのデータ型を設定：

| フィールド名 | 推奨データ型 | 理由 |
|------------|------------|------|
| Account Code アカウント | テキスト | 階層構造の維持 |
| Đơn giá | 数値 | 計算に使用 |
| Level | 数値 | 階層レベルの計算 |
| Source | テキスト | フィルタ用 |
| Has Data #1 | ブール値 | フィルタ用 |
| Has Data #2 | ブール値 | フィルタ用 |

### 3. 計算フィールドの作成

#### 実績金額フィールド（実データを接続した場合）

```
実績金額
```
※ 実績データは別途実績データファイルから接続する必要があります。

#### 予算金額フィールド

```
予算金額 = Đơn giá
```

#### 差異フィールド

```
差異 = 実績金額 - 予算金額
```

#### 差異率フィールド

```
差異率 = (実績金額 - 予算金額) / 予算金額 * 100
```

#### 階層パス（フルパス）

```
階層パス = 
  CONCAT(
    IF(Account Code アカウント IS NOT NULL, Account Code アカウント, ""),
    IF(階層レベル2 IS NOT NULL, " > " + 階層レベル2, ""),
    IF(階層レベル3 IS NOT NULL, " > " + 階層レベル3, "")
  )
```

## 可視化の推奨構成

### 1. ダッシュボード概要

#### ページ1: 全体サマリー

**チャート1: 実績 vs 予算（円グラフ）**
- ディメンション: Account Code アカウント（レベル0のみ）
- メトリクス: 実績金額合計、予算金額合計
- フィルタ: Level = 0

**チャート2: 差異トップ10**
- ディメンション: Account Code アカウント
- メトリクス: 差異（降順）
- フィルタ: 差異 != 0

**チャート3: データ存在状況**
- ディメンション: Source
- メトリクス: レコード数

#### ページ2: 詳細分析

**チャート1: 階層ツリーマップ**
- ディメンション: 階層パス
- メトリクス: 実績金額、予算金額
- 色: 差異率

**チャート2: 時系列比較（実績データに年月がある場合）**
- ディメンション: 年月、Account Code アカウント
- メトリクス: 実績金額、予算金額

**チャート3: 差異分析テーブル**
- ディメンション: 階層パス、Internal Account Name
- メトリクス: 実績金額、予算金額、差異、差異率

### 2. フィルタ設定

#### 必須フィルタ

1. **Account Code フィルタ**
   - タイプ: ドロップダウンリスト
   - 対象: Account Code アカウント
   - 用途: 特定の会計コードで絞り込み

2. **データソースフィルタ**
   - タイプ: ドロップダウンリスト
   - 対象: Source
   - デフォルト: Both（実績と予算の両方がある項目のみ）

3. **階層レベルフィルタ**
   - タイプ: スライダー
   - 対象: Level
   - 用途: 表示する階層の深さを調整

#### オプションフィルタ

1. **実績データ有無フィルタ**
   - タイプ: チェックボックス
   - 対象: Has Data #1

2. **予算データ有無フィルタ**
   - タイプ: チェックボックス
   - 対象: Has Data #2

## データ更新フロー

### 1. 実績データの追加

実績データは別途管理し、以下の方法で統合：

**方法A: 結合（推奨）**
- 実績データファイルに `Account Code アカウント` 列を追加
- Looker Studioでマスターフォーマット#3と結合
- 結合キー: `Account Code アカウント`

**方法B: データブレンディング**
- 実績データを別データソースとして追加
- データブレンディング機能で結合

### 2. 予算データの更新

- `マスターフォーマット#3_最終版.csv` の `Đơn giá` 列を更新
- Looker Studioでデータソースを再読み込み

### 3. マスターの更新

- 新しいAccount Codeが追加された場合
- `create_master_final.py` を再実行してマスターフォーマット#3を更新

## 実績データファイルの構造

実績データファイルには以下の列が必要です：

| 列名 | 必須 | 説明 |
|------|------|------|
| Account Code アカウント | ✓ | マスターフォーマット#3と一致 |
| 年月 | ✓ | 実績の年月（YYYY-MM形式） |
| 実績金額 | ✓ | 実績数値 |
| その他の属性 | - | 必要に応じて追加 |

## 注意事項

### 1. データの整合性

- Account Codeは階層構造を維持する必要があります
- 実績データのAccount Codeはマスターフォーマット#3と完全一致する必要があります

### 2. パフォーマンス

- 大量のデータがある場合は、階層レベルでフィルタリングを推奨
- 集計計算は適切にキャッシュを設定

### 3. データ更新頻度

- 実績データ: 月次更新を推奨
- 予算データ: 四半期ごとまたは年次更新
- マスター: Account Codeの変更時のみ更新

## トラブルシューティング

### 問題1: 実績データが表示されない

**原因**: Account Codeの不一致

**解決方法**:
1. 実績データのAccount Codeを確認
2. マスターフォーマット#3のAccount Codeと一致しているか確認
3. スペースや特殊文字の有無を確認

### 問題2: 階層構造が正しく表示されない

**原因**: Levelフィールドの設定ミス

**解決方法**:
1. Levelフィールドが数値型になっているか確認
2. 階層パス計算フィールドを確認

### 問題3: 予算金額が表示されない

**原因**: Đơn giá列のデータ型がテキスト

**解決方法**:
1. Đơn giá列を数値型に変更
2. カンマ区切りの数値は削除して数値のみに

## 今後の拡張

### 1. 複数年度の比較

- 実績データに年度列を追加
- 年度ごとの比較チャートを作成

### 2. 部門別分析

- 部門列を追加
- 部門ごとの実績・予算比較

### 3. 予測機能

- 過去の実績から将来予測を計算
- 予測と予算の比較

## 関連ファイル

- `Glory　Format - Compara.csv`: 元の比較データ
- `マスターフォーマット#3_最終版.csv`: 統合マスターフォーマット
- `create_master_final.py`: マスターフォーマット生成スクリプト

## 更新履歴

- 2025-01-XX: 初版作成
- マスターフォーマット#3作成完了
- Looker Studio設計書作成完了

